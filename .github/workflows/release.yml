name: Create App Release

on:
  push:
    branches:
      - main

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # WICHTIG: Holt die ganze Historie für das Changelog

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Set up Node.js v22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Install npm dependencies
        run: npm install

      - name: Build Web App
        run: npm run build

      - name: Install Capacitor Assets and Generate Icons
        run: |
          npm install @capacitor/assets -D
          npx capacitor-assets generate --assetPath . --android

      - name: Sync Capacitor project
        run: npx cap sync android

      - name: Copy custom Android resources
        run: |
          if [ -d "android-resources" ]; then
            echo "Copying custom Android resources..."
            mkdir -p android/app/src/main/res/
            cp -r android-resources/* android/app/src/main/res/
          fi

      - name: Remove Internet Permission for Release Build
        run: |
          MANIFEST_PATH="android/app/src/main/AndroidManifest.xml"
          PERMISSION_PATTERN='<uses-permission.*android:name="android.permission.INTERNET".*>'
          if grep -q -E "$PERMISSION_PATTERN" "$MANIFEST_PATH"; then
            echo "Internet permission found. Removing it for offline build..."
            sed -i "/${PERMISSION_PATTERN}/d" "$MANIFEST_PATH"
            echo "Internet permission removed."
          else
            echo "Internet permission not found. No changes needed."
          fi

      - name: Decode Keystore
        run: |
          echo "${{ secrets.SIGNING_KEY }}" | base64 --decode > android/app/my-release-key.jks

      - name: Build Release APK
        run: ./android/gradlew -p android assembleRelease
        env:
          RELEASE_STORE_FILE: my-release-key.jks
          RELEASE_STORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.ALIAS }}
          RELEASE_KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: Get package version
        id: package-version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Rename APK
        run: |
          mv android/app/build/outputs/apk/release/app-release.apk Medikamententagebuch-v${{ steps.package-version.outputs.version }}-${{ github.run_number }}.apk

      - name: Generate Changelog
        id: changelog
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            LOGS=$(git log --format="- %s")
          else
            LOGS=$(git log --format="- %s" $PREVIOUS_TAG..HEAD)
          fi
          
          # set multiline step output so it can be used in later steps
          {
            echo "commit_log<<EOF"
            echo "$LOGS"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "Medikamententagebuch-v${{ steps.package-version.outputs.version }}-${{ github.run_number }}.apk"
          tag: v${{ steps.package-version.outputs.version }}-${{ github.run_number }}
          name: "Release v${{ steps.package-version.outputs.version }} (Build ${{ github.run_number }})"
          body: |
            Automatisch erstelltes Release der Medikamententagebuch App.
            
            ### Änderungen in diesem Release:
            ${{ steps.changelog.outputs.commit_log }}
          token: ${{ secrets.GITHUB_TOKEN }}

  deploy-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-and-release
    permissions:
      pages: write      # to deploy to Pages
      id-token: write   # to verify the deployment originates from an appropriate source

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js v22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Install npm dependencies
        run: npm install
      
      - name: Build Web App for GitHub Pages
        run: npm run build:gh-pages
      
      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './www/browser' # Der Pfad zum Build-Output von Angular

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4