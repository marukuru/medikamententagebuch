<div class="min-h-screen w-full">
  <header class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm sticky top-0 z-30 shadow-md border-b border-slate-200 dark:border-slate-700 pt-[env(safe-area-inset-top,0rem)]">
    <div class="max-w-7xl mx-auto pl-[calc(1rem+env(safe-area-inset-left,0rem))] pr-[calc(1rem+env(safe-area-inset-right,0rem))] sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center">
          <span class="text-2xl mr-2">üíä</span>
          <span class="font-bold text-xl text-primary-600 dark:text-primary-400">Medikamententagebuch</span>
        </div>
        <div class="flex items-center gap-4">
            <button (click)="toggleTheme()" class="text-slate-500 dark:text-slate-400 hover:text-primary-600 dark:hover:text-primary-400">
              @if (dataService.theme() === 'light') {
                <i class="fas fa-moon text-xl"></i>
              } @else {
                <i class="fas fa-sun text-xl"></i>
              }
            </button>

            <!-- Kebab Menu -->
            <div class="relative">
                <button (click)="toggleMenu()" class="text-slate-500 dark:text-slate-400 hover:text-primary-600 dark:hover:text-primary-400">
                    <i class="fas fa-ellipsis-v text-xl"></i>
                </button>
                @if (menuOpen()) {
                    <div class="absolute right-0 mt-2 w-56 origin-top-right bg-white dark:bg-slate-800 divide-y divide-slate-100 dark:divide-slate-700 rounded-md shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none">
                        <div class="py-1">
                            <a (click)="navigate('diary')" class="cursor-pointer flex items-center gap-3 px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700">
                                <span class="w-6 text-center">üíä</span> Medikamententagebuch
                            </a>
                             <a (click)="navigate('stats')" class="cursor-pointer flex items-center gap-3 px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700">
                                <span class="w-6 text-center">üìä</span> Statistik
                            </a>
                             <a (click)="navigate('settings')" class="cursor-pointer flex items-center gap-3 px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700">
                                <span class="w-6 text-center">‚öôÔ∏è</span> Einstellungen
                            </a>
                            <a (click)="navigate('info')" class="cursor-pointer flex items-center gap-3 px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700">
                                <span class="w-6 text-center">‚ÑπÔ∏è</span> Informationen
                            </a>
                        </div>
                    </div>
                }
            </div>
        </div>
      </div>
    </div>
  </header>
  <main class="pb-[env(safe-area-inset-bottom,0rem)]">
    @switch (currentPage()) {
      @case ('diary') { <diary-list /> }
      @case ('stats') { <statistics /> }
      @case ('settings') { <settings /> }
      @case ('info') { <info /> }
    }
  </main>
</div>

<!-- Generic Form Modal -->
@if(uiService.currentForm(); as form) {
  <div class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 px-4 pt-[calc(1rem+env(safe-area-inset-top,0rem))] pb-[calc(1rem+env(safe-area-inset-bottom,0rem))]" (click)="uiService.cancelForm()">
    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto" (click)="$event.stopPropagation()">
        <h2 class="text-xl md:text-2xl font-bold text-primary-600 dark:text-primary-400 mb-6">{{ form.item ? 'Bearbeiten' : 'Anlegen' }}</h2>
        <form (ngSubmit)="uiService.saveForm()" class="space-y-4">
        @switch(form.type) {
            @case('Mood') {
                <input type="text" [(ngModel)]="uiService.moodForm().emoji" name="emoji" placeholder="Emoji" required class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
                <input type="text" [(ngModel)]="uiService.moodForm().description" name="description" placeholder="Beschreibung" required class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
            }
            @case('Effect') {
                <input type="text" [(ngModel)]="uiService.effectForm().emoji" name="emoji" placeholder="Emoji" required class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
                <input type="text" [(ngModel)]="uiService.effectForm().description" name="description" placeholder="Beschreibung" required class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
                <label class="block">
                  <span class="text-sm mb-1 inline-block">Wahrnehmung</span>
                  <select [(ngModel)]="uiService.effectForm().perception" name="perception" class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
                    <option [ngValue]="undefined">(keine)</option>
                    @for(opt of uiService.perceptionOptions; track opt.value) { <option [value]="opt.value">{{ opt.label }}</option> }
                  </select>
                </label>
            }
            @case('Manufacturer') {
                <input type="text" [(ngModel)]="uiService.manufacturerForm().name" name="name" placeholder="Name des Herstellers" required class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
            }
             @case('Dosage') {
                <input type="number" step="any" [(ngModel)]="uiService.dosageForm().amount" name="amount" placeholder="Menge" required class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
                <input type="text" [(ngModel)]="uiService.dosageForm().unit" name="unit" placeholder="Einheit" required class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
            }
             @case('ActiveIngredient') {
                <input type="text" [(ngModel)]="uiService.activeIngredientForm().amount" name="amount" placeholder="Menge" required class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
                <input type="text" [(ngModel)]="uiService.activeIngredientForm().unit" name="unit" placeholder="Einheit" required class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
            }
            @case('Preparation') {
                <input type="text" [(ngModel)]="uiService.preparationForm().name" name="name" placeholder="Name des Pr√§parats" required class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
                <div class="flex items-center gap-2">
                    <select [(ngModel)]="uiService.preparationForm().manufacturerId" name="manufacturerId" class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
                        <option [ngValue]="undefined">Hersteller (optional)</option>
                        @for(man of dataService.sortedManufacturers(); track man.id) { <option [value]="man.id">{{ man.name }}</option> }
                    </select>
                    <button type="button" (click)="uiService.openSubCreateForm('Manufacturer')" title="Neuen Hersteller anlegen" class="flex-shrink-0 w-9 h-9 rounded-full bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 transition-colors flex items-center justify-center">
                        <i class="fa fa-plus"></i>
                    </button>
                </div>
                <div class="flex items-center gap-2">
                    <select [(ngModel)]="uiService.preparationForm().activeIngredientId" name="activeIngredientId" class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
                        <option [ngValue]="undefined">Wirkstoffgehalt (optional)</option>
                        @for(ai of dataService.sortedActiveIngredients(); track ai.id) { <option [value]="ai.id">{{ ai.amount }} {{ ai.unit }}</option> }
                    </select>
                     <button type="button" (click)="uiService.openSubCreateForm('ActiveIngredient')" title="Neuen Wirkstoffgehalt anlegen" class="flex-shrink-0 w-9 h-9 rounded-full bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 transition-colors flex items-center justify-center">
                        <i class="fa fa-plus"></i>
                    </button>
                </div>
                <div class="flex items-center gap-2">
                    <select [(ngModel)]="uiService.preparationForm().dosageId" name="dosageId" class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
                        <option [ngValue]="undefined">Standard-Dosierung (optional)</option>
                        @for(dos of dataService.sortedDosages(); track dos.id) { <option [value]="dos.id">{{ dos.amount }} {{ dos.unit }}</option> }
                    </select>
                     <button type="button" (click)="uiService.openSubCreateForm('Dosage')" title="Neue Standard-Dosierung anlegen" class="flex-shrink-0 w-9 h-9 rounded-full bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 transition-colors flex items-center justify-center">
                        <i class="fa fa-plus"></i>
                    </button>
                </div>
            }
        }
        <div class="flex justify-end gap-3 pt-4 border-t border-slate-200 dark:border-slate-700 mt-6">
            <button type="button" (click)="uiService.cancelForm()" class="px-4 py-2 rounded-lg bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500">Abbrechen</button>
            <button type="submit" class="px-4 py-2 rounded-lg bg-primary-600 text-white hover:bg-primary-700">Speichern</button>
        </div>
        </form>
    </div>
  </div>
}
