<!-- Zeigt den Sperrbildschirm an, wenn die App gesperrt ist -->
@if (lockService.isLocked()) {
  <lock-screen />
} @else {
  <!-- Hauptlayout der App, nur sichtbar, wenn nicht gesperrt -->
  <div class="min-h-screen w-full flex flex-col" (click)="closeMenu()">
    <!-- Header-Bereich, der oben auf der Seite "klebt" -->
    <header class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm sticky top-0 z-30 shadow-md border-b border-slate-200 dark:border-slate-700 pt-[env(safe-area-inset-top,0rem)]">
      <div class="max-w-7xl mx-auto pl-[calc(1rem+env(safe-area-inset-left,0rem))] pr-[calc(1rem+env(safe-area-inset-right,0rem))] sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <!-- App-Titel und Icon -->
          <div class="flex items-center">
            <span class="text-2xl mr-2">üíä</span>
            <span class="font-bold text-xl text-primary-600 dark:text-primary-400">{{ t().appName }}</span>
          </div>
          <div class="flex items-center">
              <!-- Kebab-Men√º (drei Punkte) f√ºr die Navigation -->
              <div class="relative">
                  <!-- stopPropagation() verhindert, dass der Klick auf den Body durchgereicht wird und das Men√º sofort wieder schlie√üt -->
                  <button (click)="$event.stopPropagation(); toggleMenu()" class="text-slate-500 dark:text-slate-400 hover:text-primary-600 dark:hover:text-primary-400">
                      <i class="fas fa-ellipsis-v text-xl"></i>
                  </button>
                  <!-- Das Dropdown-Men√º, das nur angezeigt wird, wenn menuOpen() true ist -->
                  @if (menuOpen()) {
                      <div class="absolute right-0 mt-2 w-56 origin-top-right bg-white dark:bg-slate-800 divide-y divide-slate-100 dark:divide-slate-700 rounded-md shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none" (click)="$event.stopPropagation()">
                          <div class="py-1">
                              <a (click)="navigate('diary')" class="cursor-pointer flex items-center gap-3 px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover-bg-slate-700">
                                  <span class="w-6 text-center">üíä</span> {{ t().diary }}
                              </a>
                              <a (click)="navigate('stats')" class="cursor-pointer flex items-center gap-3 px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover-bg-slate-700">
                                  <span class="w-6 text-center">üìä</span> {{ t().statistics }}
                              </a>
                              <a (click)="navigate('settings')" class="cursor-pointer flex items-center gap-3 px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover-bg-slate-700">
                                  <span class="w-6 text-center">‚öôÔ∏è</span> {{ t().settings }}
                              </a>
                              <a (click)="navigate('info')" class="cursor-pointer flex items-center gap-3 px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover-bg-slate-700">
                                  <span class="w-6 text-center">‚ÑπÔ∏è</span> {{ t().info }}
                              </a>
                          </div>
                      </div>
                  }
              </div>
          </div>
        </div>
      </div>
    </header>
    <!-- Hauptinhaltsbereich -->
    <main class="flex-grow pb-[env(safe-area-inset-bottom,0rem)]">
      <!-- @switch-Block rendert die Komponente der aktuell ausgew√§hlten Seite -->
      @switch (currentPage()) {
        @case ('diary') { <diary-list /> }
        @case ('stats') { <statistics /> }
        @case ('settings') { <settings /> }
        @case ('info') { <info /> }
      }
    </main>
  </div>
}

<!-- Generisches Formular-Modal (f√ºr CRUD in den Einstellungen) -->
<!-- Wird nur angezeigt, wenn die App nicht gesperrt ist UND ein Formular im UiService aktiv ist -->
@if(!lockService.isLocked() && uiService.currentForm(); as form) {
  <div class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 px-4 pt-[calc(1rem+env(safe-area-inset-top,0rem))] pb-[calc(1rem+env(safe-area-inset-bottom,0rem))]" (click)="uiService.cancelForm()">
    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto" (click)="$event.stopPropagation()">
        <h2 class="text-xl md:text-2xl font-bold text-primary-600 dark:text-primary-400 mb-6">{{ form.item ? t().editTitle : t().createTitle }}</h2>
        <form (ngSubmit)="uiService.saveForm()" class="space-y-4">
        <!-- Der Inhalt des Formulars wird dynamisch basierend auf dem `form.type` gerendert -->
        @switch(form.type) {
            @case('Mood') {
                <button type="button" (click)="openEmojiPicker('mood')" class="w-full p-2 h-11 border rounded dark:bg-slate-700 dark:border-slate-600 text-left flex items-center hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors">
                    @if(uiService.moodForm().emoji; as emoji) {
                        <span class="text-2xl w-8">{{ emoji }}</span>
                        <span class="text-slate-500 dark:text-slate-400">{{ t().changeEmoji }}</span>
                    } @else {
                        <span class="text-slate-500 dark:text-slate-400">{{ t().formEmojiPlaceholder }}</span>
                    }
                </button>
                <input type="text" [(ngModel)]="uiService.moodForm().description" name="description" [placeholder]="t().formDescriptionPlaceholder" required class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
            }
             @case('Symptom') {
                <button type="button" (click)="openEmojiPicker('symptom')" class="w-full p-2 h-11 border rounded dark:bg-slate-700 dark:border-slate-600 text-left flex items-center hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors">
                    @if(uiService.symptomForm().emoji; as emoji) {
                        <span class="text-2xl w-8">{{ emoji }}</span>
                        <span class="text-slate-500 dark:text-slate-400">{{ t().changeEmoji }}</span>
                    } @else {
                        <span class="text-slate-500 dark:text-slate-400">{{ t().formEmojiPlaceholder }}</span>
                    }
                </button>
                <input type="text" [(ngModel)]="uiService.symptomForm().description" name="description" [placeholder]="t().formDescriptionPlaceholder" required class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
            }
            @case('Activity') {
                <button type="button" (click)="openEmojiPicker('activity')" class="w-full p-2 h-11 border rounded dark:bg-slate-700 dark:border-slate-600 text-left flex items-center hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors">
                    @if(uiService.activityForm().emoji; as emoji) {
                        <span class="text-2xl w-8">{{ emoji }}</span>
                        <span class="text-slate-500 dark:text-slate-400">{{ t().changeEmoji }}</span>
                    } @else {
                        <span class="text-slate-500 dark:text-slate-400">{{ t().formEmojiPlaceholder }}</span>
                    }
                </button>
                <input type="text" [(ngModel)]="uiService.activityForm().description" name="description" [placeholder]="t().formDescriptionPlaceholder" required class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
            }
            @case('Effect') {
                <button type="button" (click)="openEmojiPicker('effect')" class="w-full p-2 h-11 border rounded dark:bg-slate-700 dark:border-slate-600 text-left flex items-center hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors">
                    @if(uiService.effectForm().emoji; as emoji) {
                        <span class="text-2xl w-8">{{ emoji }}</span>
                        <span class="text-slate-500 dark:text-slate-400">{{ t().changeEmoji }}</span>
                    } @else {
                        <span class="text-slate-500 dark:text-slate-400">{{ t().formEmojiPlaceholder }}</span>
                    }
                </button>
                <input type="text" [(ngModel)]="uiService.effectForm().description" name="description" [placeholder]="t().formDescriptionPlaceholder" required class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
                <label class="block">
                  <span class="text-sm mb-1 inline-block">{{ t().formPerceptionLabel }}</span>
                  <select [(ngModel)]="uiService.effectForm().perception" name="perception" class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
                    <option [ngValue]="undefined">{{ t().formPerceptionNone }}</option>
                    @for(opt of uiService.perceptionOptions(); track opt.value) { <option [value]="opt.value">{{ opt.label }}</option> }
                  </select>
                </label>
            }
            @case('Manufacturer') {
                <input type="text" [(ngModel)]="uiService.manufacturerForm().name" name="name" [placeholder]="t().formManufacturerNamePlaceholder" required class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
            }
             @case('Dosage') {
                <input type="number" step="any" [(ngModel)]="uiService.dosageForm().amount" name="amount" [placeholder]="t().formDosageAmountPlaceholder" required class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
                <input type="text" [(ngModel)]="uiService.dosageForm().unit" name="unit" [placeholder]="t().formDosageUnitPlaceholder" required class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
            }
             @case('ActiveIngredient') {
                <input type="text" [(ngModel)]="uiService.activeIngredientForm().amount" name="amount" [placeholder]="t().formActiveIngredientAmountPlaceholder" required class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
                <input type="text" [(ngModel)]="uiService.activeIngredientForm().unit" name="unit" [placeholder]="t().formActiveIngredientUnitPlaceholder" required class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
            }
            @case('Preparation') {
                <input type="text" [(ngModel)]="uiService.preparationForm().name" name="name" [placeholder]="t().formPreparationNamePlaceholder" required class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
                <div class="flex items-center gap-2">
                    <select [(ngModel)]="uiService.preparationForm().manufacturerId" name="manufacturerId" class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
                        <option [ngValue]="undefined">{{ t().formPreparationManufacturerOptional }}</option>
                        @for(man of dataService.sortedManufacturers(); track man.id) { <option [value]="man.id">{{ man.name }}</option> }
                    </select>
                    <button type="button" (click)="uiService.openSubCreateForm('Manufacturer')" [title]="t().addNewManufacturerTitle" class="flex-shrink-0 w-9 h-9 rounded-full bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 transition-colors flex items-center justify-center">
                        <i class="fa fa-plus"></i>
                    </button>
                </div>
                <div class="flex items-center gap-2">
                    <select [(ngModel)]="uiService.preparationForm().activeIngredientId" name="activeIngredientId" class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
                        <option [ngValue]="undefined">{{ t().formPreparationActiveIngredientOptional }}</option>
                        @for(ai of dataService.sortedActiveIngredients(); track ai.id) { <option [value]="ai.id">{{ ai.amount }} {{ ai.unit }}</option> }
                    </select>
                     <button type="button" (click)="uiService.openSubCreateForm('ActiveIngredient')" [title]="t().addNewActiveIngredientTitle" class="flex-shrink-0 w-9 h-9 rounded-full bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 transition-colors flex items-center justify-center">
                        <i class="fa fa-plus"></i>
                    </button>
                </div>
                <div class="flex items-center gap-2">
                    <select [(ngModel)]="uiService.preparationForm().dosageId" name="dosageId" class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
                        <option [ngValue]="undefined">{{ t().formPreparationDosageOptional }}</option>
                        @for(dos of dataService.sortedDosages(); track dos.id) { <option [value]="dos.id">{{ dos.amount }} {{ dos.unit }}</option> }
                    </select>
                     <button type="button" (click)="uiService.openSubCreateForm('Dosage')" [title]="t().addNewDosageTitle" class="flex-shrink-0 w-9 h-9 rounded-full bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 transition-colors flex items-center justify-center">
                        <i class="fa fa-plus"></i>
                    </button>
                </div>
            }
            @case('CustomEmoji') {
                <input type="text" [(ngModel)]="uiService.customEmojiForm().emoji" name="emoji" [placeholder]="t().formCustomEmojiPlaceholder" required maxlength="10" class="w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600 text-2xl text-center">
            }
        }
        <div class="flex justify-end flex-wrap gap-2 pt-4 border-t border-slate-200 dark:border-slate-700 mt-6">
            <button type="button" (click)="uiService.cancelForm()" class="px-4 py-2 rounded-lg bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500">{{ t().cancel }}</button>
            <button type="submit" class="px-4 py-2 rounded-lg bg-primary-600 text-white hover:bg-primary-700">{{ t().save }}</button>
        </div>
        </form>
    </div>
  </div>
}
<!-- Die Toast-Komponente wird hier platziert, damit sie √ºber allem anderen angezeigt wird -->
<toast-notifications></toast-notifications>

<!-- Emoji Picker Modal -->
@if(showEmojiPicker()) {
    <emoji-picker (emojiSelect)="onEmojiSelected($event)" (close)="closeEmojiPicker()" />
}