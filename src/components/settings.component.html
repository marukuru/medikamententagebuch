<div class="p-4 md:p-6">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-2xl md:text-3xl font-bold text-primary-600 dark:text-primary-400 mb-6 flex items-center gap-3">
      <span class="text-3xl md:text-4xl">‚öôÔ∏è</span>
      <span>{{ t().settingsTitle }}</span>
    </h1>

    <div class="space-y-8">
      <!-- CRUD SECTIONS -->
      @for (entity of entityConfigs(); track entity.type) {
        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md border border-slate-200 dark:border-slate-700">
          <div class="flex justify-between items-center mb-4 gap-4">
            <h2 class="text-xl md:text-2xl font-semibold flex items-center gap-3">
              <span class="text-2xl md:text-3xl">{{ entity.emoji }}</span>
              <span>{{ entity.title }}</span>
            </h2>
            <button (click)="openCreateForm(entity.type)" [title]="t().addNewEntryTitle" class="flex-shrink-0 w-9 h-9 rounded-full bg-primary-500 text-white hover:bg-primary-600 transition-colors flex items-center justify-center">
              <i class="fa fa-plus"></i>
            </button>
          </div>
          <div class="max-h-60 overflow-y-auto pr-2">
            @if(entity.items.length > 0) {
              <ul class="space-y-2">
                @for(item of entity.items; track item.id) {
                  <li class="flex justify-between items-center p-2 rounded-lg bg-slate-50 dark:bg-slate-700/50">
                    <span class="text-slate-800 dark:text-slate-200">{{ entity.display(item) }}</span>
                    <div class="flex gap-2">
                      <button (click)="openEditForm(entity.type, item)" class="text-yellow-500 hover:text-yellow-600"><i class="fa fa-pencil"></i></button>
                      <button (click)="requestDeleteItem(entity.type, item.id, entity.display(item))" class="text-red-500 hover:text-red-600"><i class="fa fa-trash"></i></button>
                    </div>
                  </li>
                }
              </ul>
            } @else {
              <p class="text-slate-500 dark:text-slate-400 text-center py-4">{{ t().noEntriesAvailable }}</p>
            }
          </div>
        </div>
      }
      <!-- Design -->
      <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md border border-slate-200 dark:border-slate-700">
        <h2 class="text-xl md:text-2xl font-semibold mb-4 flex items-center gap-2">
            <span class="text-3xl">üé®</span>
            <span>{{ t().design }}</span>
        </h2>
        <div class="flex flex-wrap gap-4">
            <button 
              (click)="dataService.theme.set('light')"
              [class.bg-primary-600]="dataService.theme() === 'light'"
              [class.text-white]="dataService.theme() === 'light'"
              [class.bg-slate-200]="dataService.theme() !== 'light'"
              [class.dark:bg-slate-600]="dataService.theme() !== 'light'"
              class="px-4 py-2 rounded-lg hover:bg-primary-500 hover:text-white transition-colors">
              {{ t().lightTheme }}
            </button>
            <button 
              (click)="dataService.theme.set('dark')"
              [class.bg-primary-600]="dataService.theme() === 'dark'"
              [class.text-white]="dataService.theme() === 'dark'"
              [class.bg-slate-200]="dataService.theme() !== 'dark'"
              [class.dark:bg-slate-600]="dataService.theme() !== 'dark'"
              class="px-4 py-2 rounded-lg hover:bg-primary-500 hover:text-white transition-colors">
              {{ t().darkTheme }}
            </button>
        </div>
      </div>
      <!-- Language -->
      <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md border border-slate-200 dark:border-slate-700">
        <h2 class="text-xl md:text-2xl font-semibold mb-4 flex items-center gap-2">
            <span class="text-3xl">üåê</span>
            <span>{{ t().language }}</span>
        </h2>
        <div class="flex flex-wrap gap-4">
            <button 
              (click)="setLanguage('de')"
              [class.bg-primary-600]="translationService.language() === 'de'"
              [class.text-white]="translationService.language() === 'de'"
              [class.bg-slate-200]="translationService.language() !== 'de'"
              [class.dark:bg-slate-600]="translationService.language() !== 'de'"
              class="px-4 py-2 rounded-lg hover:bg-primary-500 hover:text-white transition-colors">
              {{ t().german }}
            </button>
            <button 
              (click)="setLanguage('en')"
              [class.bg-primary-600]="translationService.language() === 'en'"
              [class.text-white]="translationService.language() === 'en'"
              [class.bg-slate-200]="translationService.language() !== 'en'"
              [class.dark:bg-slate-600]="translationService.language() !== 'en'"
              class="px-4 py-2 rounded-lg hover:bg-primary-500 hover:text-white transition-colors">
              {{ t().english }}
            </button>
        </div>
      </div>
      <!-- Security -->
      <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md border border-slate-200 dark:border-slate-700">
        <h2 class="text-xl md:text-2xl font-semibold mb-4 flex items-center gap-2">
            <span class="text-3xl">üîí</span>
            <span>{{ t().security }}</span>
        </h2>
        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <label for="enable-lock" class="font-medium text-slate-700 dark:text-slate-300">{{ t().enableAppLock }}</label>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="enable-lock" 
                [checked]="dataService.lockSettings().isEnabled" 
                (change)="toggleLock($event)"
                class="sr-only peer">
              <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-300 dark:peer-focus:ring-primary-800 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-slate-600 peer-checked:bg-primary-600"></div>
            </label>
          </div>
          @if(dataService.lockSettings().isEnabled) {
            <div class="flex items-center justify-between">
              <span class="font-medium text-slate-700 dark:text-slate-300">{{ t().changePin }}</span>
              <button (click)="openPinModal('change')" class="px-4 py-2 rounded-lg bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 text-sm">
                {{ t().change }}
              </button>
            </div>
            <div class="flex items-center justify-between">
              <label for="auto-lock-timeout" class="font-medium text-slate-700 dark:text-slate-300">{{ t().autoLock }}</label>
              <select id="auto-lock-timeout" 
                [ngModel]="dataService.lockSettings().timeout"
                (ngModelChange)="updateTimeout($event)"
                class="p-2 border rounded dark:bg-slate-700 dark:border-slate-600">
                @for(opt of timeoutOptions(); track opt.value) {
                  <option [value]="opt.value">{{ opt.label }}</option>
                }
              </select>
            </div>
          }
        </div>
      </div>
      <!-- Data Management -->
      <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md border border-slate-200 dark:border-slate-700">
        <h2 class="text-xl md:text-2xl font-semibold mb-4 flex items-center gap-2">
            <span class="text-3xl">üíæ</span>
            <span>{{ t().dataManagement }}</span>
        </h2>
        <div class="flex flex-wrap gap-4">
            <button (click)="exportData()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">{{ t().export }}</button>
            <button (click)="triggerImport()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">{{ t().import }}</button>
            <input type="file" id="import-file" class="hidden" (change)="importData($event)" accept=".json">
            <button (click)="resetAllData()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">{{ t().resetApp }}</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- PIN Modal -->
@if(showPinModal()) {
  <div class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[60] px-4 pt-[calc(1rem+env(safe-area-inset-top,0rem))] pb-[calc(1rem+env(safe-area-inset-bottom,0rem))]" (click)="closePinModal()">
    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-sm" (click)="$event.stopPropagation()">
      <h3 class="text-xl font-bold mb-4">{{ pinModalMode() === 'create' ? t().createPinTitle : t().changePinTitle }}</h3>
      <div class="space-y-4">
        <div>
          <label for="pin" class="block text-sm font-medium text-slate-700 dark:text-slate-300">{{ t().pinLabel }}</label>
          <input type="password" id="pin" name="pin" [(ngModel)]="pinEntry" pattern="[0-9]*" inputmode="numeric" minlength="4" maxlength="4" required
            class="mt-1 block w-full p-2 text-lg tracking-[1em] text-center border-slate-300 dark:border-slate-600 focus:outline-none focus:ring-primary-500 focus:border-primary-500 rounded-md bg-white dark:bg-slate-700">
        </div>
         <div>
          <label for="pin-confirm" class="block text-sm font-medium text-slate-700 dark:text-slate-300">{{ t().pinConfirmLabel }}</label>
          <input type="password" id="pin-confirm" name="pin-confirm" [(ngModel)]="pinConfirm" pattern="[0-9]*" inputmode="numeric" minlength="4" maxlength="4" required
            class="mt-1 block w-full p-2 text-lg tracking-[1em] text-center border-slate-300 dark:border-slate-600 focus:outline-none focus:ring-primary-500 focus:border-primary-500 rounded-md bg-white dark:bg-slate-700">
        </div>
        @if(pinError()) {
          <p class="text-sm text-red-500">{{ pinError() }}</p>
        }
      </div>
      <div class="flex justify-end flex-wrap gap-2 mt-6">
        <button (click)="closePinModal()" class="px-6 py-2 rounded-lg bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 transition-colors">
          {{ t().cancel }}
        </button>
        <button (click)="savePin()" class="px-6 py-2 rounded-lg bg-primary-600 text-white hover:bg-primary-700 transition-colors">
          {{ t().save }}
        </button>
      </div>
    </div>
  </div>
}

<!-- Delete item confirmation modal -->
@if(itemToDelete(); as item) {
  <div class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[60] px-4 pt-[calc(1rem+env(safe-area-inset-top,0rem))] pb-[calc(1rem+env(safe-area-inset-bottom,0rem))]" (click)="cancelDeleteItem()">
    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-sm text-center" (click)="$event.stopPropagation()">
      <h3 class="text-xl font-bold mb-4">{{ t().confirmDeleteItemTitle }}</h3>
      <p class="text-slate-600 dark:text-slate-400 mb-6">{{ t().confirmDeleteItemMessage.replace('{{name}}', item.name) }}</p>
      <div class="flex justify-center flex-wrap gap-2">
        <button (click)="cancelDeleteItem()" class="px-6 py-2 rounded-lg bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 transition-colors">
          {{ t().cancel }}
        </button>
        <button (click)="confirmDeleteItem()" class="px-6 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition-colors">
          {{ t().confirmDeleteButton }}
        </button>
      </div>
    </div>
  </div>
}

<!-- Import confirmation modal -->
@if(importFileContent()) {
  <div class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[60] px-4 pt-[calc(1rem+env(safe-area-inset-top,0rem))] pb-[calc(1rem+env(safe-area-inset-bottom,0rem))]" (click)="cancelImport()">
    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-sm text-center" (click)="$event.stopPropagation()">
      <h3 class="text-xl font-bold mb-4">{{ t().confirmImportTitle }}</h3>
      <p class="text-slate-600 dark:text-slate-400 mb-6">{{ t().confirmImportMessage }}</p>
      <div class="flex justify-center flex-wrap gap-2">
        <button (click)="cancelImport()" class="px-6 py-2 rounded-lg bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 transition-colors">
          {{ t().cancel }}
        </button>
        <button (click)="confirmImport()" class="px-6 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors">
          {{ t().confirmImportButton }}
        </button>
      </div>
    </div>
  </div>
}

<!-- Reset confirmation step 1 modal -->
@if(showResetConfirmStep1()) {
  <div class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[60] px-4 pt-[calc(1rem+env(safe-area-inset-top,0rem))] pb-[calc(1rem+env(safe-area-inset-bottom,0rem))]" (click)="cancelReset()">
    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-sm text-center" (click)="$event.stopPropagation()">
      <h3 class="text-xl font-bold mb-4 text-red-600">{{ t().resetWarningTitle }}</h3>
      <p class="text-slate-600 dark:text-slate-400 mb-6">{{ t().resetWarningMessage }}</p>
      <div class="flex justify-center flex-wrap gap-2">
        <button (click)="cancelReset()" class="px-6 py-2 rounded-lg bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 transition-colors">
          {{ t().cancel }}
        </button>
        <button (click)="proceedToResetStep2()" class="px-6 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition-colors">
          {{ t().continue }}
        </button>
      </div>
    </div>
  </div>
}

<!-- Reset confirmation step 2 modal -->
@if(showResetConfirmStep2()) {
  <div class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-[60] px-4 pt-[calc(1rem+env(safe-area-inset-top,0rem))] pb-[calc(1rem+env(safe-area-inset-bottom,0rem))]" (click)="cancelReset()">
    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-sm text-center" (click)="$event.stopPropagation()">
      <h3 class="text-xl font-bold mb-4 text-red-600">{{ t().finalConfirmationTitle }}</h3>
      <p class="text-slate-600 dark:text-slate-400 mb-6">{{ t().finalConfirmationMessage }}</p>
      <div class="flex justify-center flex-wrap gap-2">
        <button (click)="cancelReset()" class="px-6 py-2 rounded-lg bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 transition-colors">
          {{ t().cancel }}
        </button>
        <button (click)="confirmReset()" class="px-6 py-2 rounded-lg bg-red-800 text-white hover:bg-red-900 transition-colors">
          {{ t().deleteAll }}
        </button>
      </div>
    </div>
  </div>
}